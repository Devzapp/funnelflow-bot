<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>funnelflow-bot</title>
    <meta name="description" content="Grupos +  Funil Devzapp" />
    <meta name="author" content="Devzapp" />

    <meta property="og:title" content="funnelflow-bot" />
    <meta property="og:description" content="Grupos +  Funil Devzapp" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@devzapp" />
    <meta name="twitter:image" content="https://lovable.dev/opengraph-image-p98pqg.png" />
  </head>

  <body>
    <div id="root"></div>
    <!-- Meta Pixel Code -->
<script>
  !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;
  n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);
  t.async=!0;t.src=v;s=b.getElementsByTagName(e)[0];
  s.parentNode.insertBefore(t,s)}(window, document,'script',
  'https://connect.facebook.net/en_US/fbevents.js');
  fbq('init', '1157595497996556');
  fbq('track', 'PageView');
</script>

    <script>
(function () {
  // ======== CONFIG ========
  var POST_URL = "https://testeutm-463492272412.us-east4.run.app/utmIngest";
  var API_KEY  = "";
  var CLICK_POST_TIMEOUT_MS = 700;
  var CLICK_SELECTOR = 'a, [data-href], [data-url], [gpc-link], button[data-href], button[data-url], .gpc_botao, .link_externo';
  var APPLY_UTM_TO_ALL_LINKS_ON_DOMREADY = true;

  var FORCE_REFERRER_HOSTS = ['checkout.devzapp.com.br'];
  var LINK_REFERRER_POLICY = 'no-referrer-when-downgrade';
  // ========================

  function log(){ try { console.log.apply(console, arguments); } catch(_){} }
  function warn(){ try { console.warn.apply(console, arguments); } catch(_){} }
  function normSpaces(s){ s = s==null?'':String(s); s=s.split('+').join('_'); s=s.split('%20').join('_'); s=s.split('%2B').join('_'); s=s.split('%2b').join('_'); return s; }
  function parseQueryLiteral(url){ var out={}; try{ if(!url||url.indexOf('?')===-1) return out; url=url.split('#',1)[0]; var q=url.substring(url.indexOf('?')+1).split('&'); for(var i=0;i<q.length;i++){ if(!q[i]) continue; var idx=q[i].indexOf('='); var k=idx===-1?q[i]:q[i].slice(0,idx); var v=idx===-1?'':q[i].slice(idx+1); k=normSpaces(k); v=normSpaces(v); if(Object.prototype.hasOwnProperty.call(out,k)){ if(!Array.isArray(out[k])) out[k]=[out[k]]; out[k].push(v); } else out[k]=v; } }catch(_){ } return out; }
  function buildQueryLiteral(obj){ var parts=[]; for(var k in obj) if(Object.prototype.hasOwnProperty.call(obj,k)){ var v=obj[k]; if(Array.isArray(v)){ for(var i=0;i<v.length;i++) parts.push(k+'='+v[i]); } else parts.push(k+'='+v); } return parts.join('&'); }
  function parseExistingQueryLiteral(href){ if(!href||href.indexOf('?')===-1) return {}; var base=href.split('#',1)[0]; return parseQueryLiteral(base); }
  function mergeParamsIntoUrlLiteral(href, params){
    if(!href) return href;
    var hash='',hi=href.indexOf('#'); if(hi!==-1){ hash=href.slice(hi); href=href.slice(0,hi); }
    var hasQ=href.indexOf('?')!==-1; var base=hasQ?href.split('?',1)[0]:href;
    var existing=hasQ?parseExistingQueryLiteral(href):{};
    for(var key in params) if(Object.prototype.hasOwnProperty.call(params,key)) delete existing[key];
    var merged={}; for(var ek in existing) if(Object.prototype.hasOwnProperty.call(existing,ek)) merged[ek]=existing[ek];
    for(var nk in params) if(Object.prototype.hasOwnProperty.call(params,nk)) merged[nk]=params[nk];
    var q=buildQueryLiteral(merged); return (q?(base+'?'+q):base)+hash;
  }
  function firstOf(v){ return Array.isArray(v)?(v[0]||null):(v||null); }
  function getSessionId(){ try{ var k='gpc_sid'; var sid=sessionStorage.getItem(k); if(!sid){ sid=Date.now().toString(36)+'-'+Math.random().toString(36).slice(2,8); sessionStorage.setItem(k,sid);} return sid; }catch(_){ return null; } }
  function getHrefFromEl(el){ if(!el) return null; if(el.tagName && el.tagName.toLowerCase()==='a'){ return el.href||el.getAttribute('href')||null; } return el.getAttribute('data-href')||el.getAttribute('data-url')||el.getAttribute('gpc-link')||null; }
  function setHrefOnEl(el,url){ if(!el) return; if(el.tagName && el.tagName.toLowerCase()==='a'){ el.setAttribute('href',url); } else if(el.hasAttribute('data-href')){ el.setAttribute('data-href',url); } else if(el.hasAttribute('data-url')){ el.setAttribute('data-url',url); } else if(el.hasAttribute('gpc-link')){ el.setAttribute('gpc-link',url); } }
  function isNavigableUrl(u){ if(!u) return false; var s=String(u).trim(); if(!s||s==='#'||s.toLowerCase().indexOf('javascript:')===0) return false; if(s.indexOf('mailto:')===0||s.indexOf('tel:')===0) return false; return true; }
  function getButtonText(el){ if(!el) return null; var t=(el.innerText||el.textContent||'').trim(); if(!t) t=(el.getAttribute('aria-label')||el.getAttribute('title')||el.value||'').trim(); return t||null; }

  function ensureReferrerPolicy(el, absUrl){
    try{
      if(!(el && el.tagName && el.tagName.toLowerCase()==='a')) return;
      var host=absUrl.hostname;
      if(FORCE_REFERRER_HOSTS.indexOf(host)!==-1){
        el.setAttribute('referrerpolicy', LINK_REFERRER_POLICY);
        var rel=(el.getAttribute('rel')||'').replace(/bnoreferrerb/g,'').replace(/s{2,}/g,' ').trim();
        if(rel) el.setAttribute('rel', rel); else el.removeAttribute('rel');
      }
    }catch(_){}
  }

  // >>> CORRIGIDO: grava src SEM encode (o URL serializa e codifica 1x)
  function ensureFallbackParams(urlStr){
    try{
      var u=new URL(urlStr, location.href);
      if(!u.searchParams.has('src')){ u.searchParams.set('src', String(location.href)); }
      if(!u.searchParams.has('clid')){ var sid=getSessionId(); if(sid) u.searchParams.set('clid', sid); }
      return u.href;
    }catch(_){ return urlStr; }
  }

  function buildPayload(utm, btnText, targetUrl){
    var fullRef=String(location.href);
    var browserRef=document.referrer||'';
    var combinedRef=(browserRef && browserRef!==fullRef)?(fullRef+' || '+browserRef):fullRef;
    return {
      utm_source:firstOf(utm.utm_source), utm_medium:firstOf(utm.utm_medium), utm_campaign:firstOf(utm.utm_campaign),
      utm_term:firstOf(utm.utm_term), utm_content:firstOf(utm.utm_content),
      gclid:firstOf(utm.gclid)||firstOf(utm.gclsrc), fbclid:firstOf(utm.fbclid), wbraid:firstOf(utm.wbraid),
      click_id:firstOf(utm.click_id)||firstOf(utm.clickid)||firstOf(utm.clickId),
      page_url:fullRef, referrer:combinedRef, session_id:getSessionId(),
      user_agent:(navigator&&navigator.userAgent)?navigator.userAgent:null,
      button_text:btnText, click_target:targetUrl
    };
  }

  function postPayload(payload,onDone){
    try{
      var headers={'Content-Type':'application/json'}; if(API_KEY) headers['x-api-key']=API_KEY;
      var ac=(typeof AbortController!=='undefined')?new AbortController():null; var timedOut=false;
      var timer=setTimeout(function(){ timedOut=true; try{ac&&ac.abort();}catch(_){} onDone&&onDone('timeout'); }, CLICK_POST_TIMEOUT_MS);
      fetch(POST_URL,{method:'POST',headers:headers,body:JSON.stringify(payload),keepalive:true,signal:ac?ac.signal:void 0,cache:'no-store',credentials:'omit',mode:'cors'})
      .then(function(resp){ if(timedOut) return; clearTimeout(timer); return resp.text().catch(function(){return'';}); })
      .then(function(){ onDone&&onDone(null); })
      .catch(function(){ if(timedOut) return; clearTimeout(timer); if(!API_KEY && navigator && typeof navigator.sendBeacon==='function'){ try{ navigator.sendBeacon(POST_URL,new Blob([JSON.stringify(payload)],{type:'application/json'})); }catch(_){} } onDone&&onDone('error'); });
    }catch(e){ onDone&&onDone('error'); }
  }

  function navigate(targetUrl,newTab,el){ try{ if(newTab){ var win=window.open(targetUrl,(el&&el.getAttribute('target'))||'_blank'); if(!win) location.href=targetUrl; } else { location.href=targetUrl; } }catch(_){ location.href=targetUrl; } }

  function applyToLinks(){
    try{
      var utm=parseQueryLiteral(String(location.href)); var hasUtm=!!buildQueryLiteral(utm);
      var nodes=document.querySelectorAll('a, [gpc-link], [data-href], [data-url], .gpc_botao, .link_externo'); var changed=0;
      for(var i=0;i<nodes.length;i++){
        var el=nodes[i]; var url=getHrefFromEl(el); if(!isNavigableUrl(url)) continue;
        if(hasUtm){ var merged=mergeParamsIntoUrlLiteral(url,utm); if(merged && merged!==url){ setHrefOnEl(el,merged); url=merged; changed++; } }
        var withFallback=ensureFallbackParams(url); if(withFallback!==url){ setHrefOnEl(el,withFallback); url=withFallback; changed++; }
        try{ var abs=new URL(url,location.href); ensureReferrerPolicy(el,abs); }catch(_){}
      }
      log('[UTM] links tratados â€” alterados:',changed);
    }catch(e){ warn('[UTM] applyToLinks erro:',e&&e.message?e.message:e); }
  }

  document.addEventListener('click', function (ev) {
    var el = ev.target && ev.target.closest ? ev.target.closest(CLICK_SELECTOR) : null; if(!el) return;
    var url = getHrefFromEl(el); if(!isNavigableUrl(url)) return;
    var isMiddle=(ev.button===1);
    var newTab=isMiddle||ev.ctrlKey||ev.metaKey||ev.shiftKey||(el.getAttribute&&el.getAttribute('target')==='_blank');
    var utm=parseQueryLiteral(String(location.href));
    var mergedUrl=mergeParamsIntoUrlLiteral(url, utm); if(mergedUrl && mergedUrl!==url){ setHrefOnEl(el,mergedUrl); url=mergedUrl; }
    var finalUrl=ensureFallbackParams(url); if(finalUrl!==url){ setHrefOnEl(el,finalUrl); url=finalUrl; }
    try{ var abs2=new URL(url,location.href); ensureReferrerPolicy(el,abs2); }catch(_){}
    var btnText=getButtonText(el); var payload=buildPayload(utm,btnText,url);
    if(newTab){ postPayload(payload,function(){}); return; }
    ev.preventDefault(); postPayload(payload,function(){ navigate(url,false,el); });
  }, { capture:true, passive:false });

  (function(){ try{ var utm=parseQueryLiteral(String(location.href)); var payload=buildPayload(utm,'(page_load)',null); postPayload(payload,function(){}); }catch(e){} })();

  if (APPLY_UTM_TO_ALL_LINKS_ON_DOMREADY) {
    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', applyToLinks);
    else applyToLinks();
  }
})();
</script>


<noscript>
  <img height="1" width="1"
       src="https://www.facebook.com/tr?id=1157595497996556&ev=PageView&noscript=1"/>
</noscript>
<!-- End Meta Pixel Code -->

    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
